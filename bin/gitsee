#!/bin/bash

usage() { echo "Usage: $0 [-r remote] [-b branch] [-p path]" 1>&2; exit 1; }

PATH_SUFFIX=
REMOTE=origin
BRANCH=$(git rev-parse --abbrev-ref HEAD)

while getopts ":p:r:b:" o; do
  case "${o}" in
    p)
      [ -n "${OPTARG+1}" ] || usage
      PATH_SUFFIX=${OPTARG}
      ;;
    r)
      [ -n "${OPTARG+1}" ] || usage
      REMOTE=${OPTARG}
      ;;
    b)
      [ -n "${OPTARG+1}" ] || usage
      BRANCH=${OPTARG}
      ;;
    *)
      usage
      ;;
  esac
done

REMOTE_VERBOSE=$(git remote -v)
REPO=$([[ $REMOTE_VERBOSE =~ ${REMOTE}[[:space:]]+(https:\/\/|git@)(github|gitlab|bitbucket)\.com(\:|\/)([^[:space:]]+)\.git? ]] && echo ${BASH_REMATCH[4]})
REPO_URL=https://github.com/${REPO}

# check if the branch they want exists
if git ls-remote --heads --exit-code "$REPO_URL" "$BRANCH"; then
  echo -e branch "\x1b[36m$BRANCH\x1b[0m" is in remote "\x1b[33m$REMOTE\x1b[0m"
else
  echo -e branch "\x1b[36m$BRANCH\x1b[0m" is not in remote "\x1b[33m$REMOTE\x1b[0m"
  exit 1
fi

PATH_PREFIX=$(git rev-parse --show-prefix)
FULL_URL=${REPO_URL}/tree/${BRANCH}/${PATH_PREFIX}

if [ -n "${PATH_SUFFIX+1}" ]; then
  FULL_URL="$FULL_URL$PATH_SUFFIX"
fi

open $FULL_URL

